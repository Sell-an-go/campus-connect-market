<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CampusMarket</title>
    <link rel="stylesheet" href="../styleSheets/style.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
    />
  </head>
  <body>
    <div class="container">
      <header>
            <nav class="navbar">

                <a href="" class="logo">
                    <img src="../views/weblogo.png" alt="CampusMarket Logo"> <div>
                        <strong>CampusMarket</strong>
                        <span>Student Marketplace</span>
                    </div>
                </a>
                <div class="profile-dropdown">
                    <a href="/pages/login.html" class="nav-button active" id="active"> 
                        <i class="fa-regular fa-user"></i>
                        <span id="isActive">Login</span>
                    </a>
                    <div class="dropdown-content" id="profileDropdown">
                        <a href=""> <i class="fa-solid fa-user-circle"></i> Profile</a>
                        <a id="logout-btn"> Logout</a>
                    </div>
                </div>
            </nav>
        </header>

      <main>
        <section class="hero">
          <h1>Find Great Deals at Your Campus</h1>
          <p>
            Buy and sell items with fellow students. From furniture to
            electronics, find everything you need for college life.
          </p>
          <div class="search-bar">
            <i class="fa-solid fa-magnifying-glass"></i>
            <input type="text" id="search-bar" placeholder="Search for products..." />
          </div>
        </section>

        <section class="filters-stats-section">
          <div class="filters">
            <span><i class="fa-solid fa-filter"></i> Filters:</span>
            <button id="filter-btn-All Categories" class="filter-btn active" value="all categories">
              All Categories
            </button>
            <button id="filter-btn-Furniture" class="filter-btn" value-="furniture">
              Furniture
            </button>
            <button id="filter-btn-Electronics" class="filter-btn" value="electronics">
              Electronics
            </button>
            <button id="filter-btn-Books" class="filter-btn" value="books">Books</button>
            <button id="filter-btn-Appliances" class="filter-btn" value="appliances">
              Appliances
            </button>
            <button id="filter-btn-Clothing" class="filter-btn" value="clothing">
              Clothing
            </button>
            <button id="filter-btn-Other" class="filter-btn" value="other">Other</button>

            <select
              id="filter-btn-college"
              class="college-filter"
              value="All Colleges"
            >
              <option id="All Colleges" class="select-options-college">
                All Colleges
              </option>
            </select>
          </div>
          <div class="stats-cards">
            <div class="stat-card">
              <h3 id="TotalItems">10</h3>
              <p>Available Items</p>
            </div>
            <div class="stat-card">
              <h3 id="TotalColleges">9</h3>
              <p>Colleges</p>
            </div>
            <div class="stat-card">
              <h3>6</h3>
              <p>Categories</p>
            </div>
          </div>
        </section>

        <section class="listings-section">
          <div class="listings-header">
            <h2>Recent Listings</h2>
            <a href="#">View All ></a>
          </div>

          <div class="product-grid" id="product-grid">
            <!-- New Product Added here -->
          </div>
        </section>
      </main>
    </div>

    <div id="product-modal" class="modal-overlay">
      <div class="modal-content">
        <button class="modal-close-btn">&times;</button>
        <h2 class="modal-title">Product Title</h2>
        <div class="modal-body">
          <div class="modal-image-container">
            <img
              id="modal-image"
              src="https://placehold.co/600x400/E0E7FF/4F46E5?text=Product+Image"
              alt="Product Image"
            />
          </div>
          <div class="modal-details">
            <p class="modal-price">₹2500</p>
            <div class="modal-tags">
              <span id="modal-category" class="modal-tag category"
                >Furniture</span
              >
              <span id="modal-condition" class="modal-tag condition">Good</span>
            </div>
            <h3>Description</h3>
            <p class="modal-description">
              Detailed product description goes here. It provides more
              information than the short summary on the card.
            </p>
            <h3>Location</h3>
            <p class="modal-location">
              <i class="fa-solid fa-location-dot"></i> Location details
            </p>
            <hr />
            <h3>Contact Seller</h3>
            <button class="modal-contact-btn">Show Contact Details</button>
          </div>
        </div>
      </div>
    </div>

    <script>
      // - - - -- -  - - - -- - - - - - - -- - - - - - - - //
      const modalOverlay = document.getElementById("product-modal");
      const productCards = document.querySelectorAll(".product-card");
      const modalCloseBtn = document.querySelector(".modal-close-btn");

      // Get all modal element
      const modal = document.getElementById("product-modal");
      const modalTitle = document.querySelector(".modal-title");
      const modalImage = document.getElementById("modal-image");
      const modalPrice = document.querySelector(".modal-price");
      const modalCategory = document.getElementById("modal-category");
      const modalCondition = document.getElementById("modal-condition");
      const modalDescription = document.querySelector(".modal-description");
      const modalLocation = document.querySelector(".modal-location");


      const openModal = (product) => {
        modalTitle.textContent = product.title;
        modalImage.src = product.image_urls;
        modalPrice.textContent = `₹${product.price}`;
        modalCategory.textContent = product.category;
        modalCondition.textContent = product.condition;
        modalDescription.textContent = product.description;
        modalLocation.innerHTML = `<i class="fa-solid fa-location-dot"></i> ${product.location}`;
  
        modalOverlay.style.display = "flex";
      };

      const closeModal = () => {
        modalOverlay.style.display = "none";
      };

      modalCloseBtn.addEventListener("click", closeModal);

      modalOverlay.addEventListener("click", (event) => {
        if (event.target === modalOverlay) {
          closeModal();
        }
      });

      // ---  Filter Button Highlighting ---
      let filterButtons = document.querySelectorAll(".filter-btn");
      filterButtons.forEach((button) => {
        button.addEventListener("click", () => {
          document
            .querySelector(".filter-btn.active")
            ?.classList.remove("active");
          button.classList.add("active");
        });
      });

      // Load Products
      async function loadProducts(API_Params) {
        try {
          let response = await fetch(
            `http://localhost:2000/getProduct?${API_Params}`
          );
          let products = await response.json();

          const grid = document.getElementById("product-grid");
          const TotalItemsElement = document.getElementById("TotalItems");
          TotalItemsElement.innerHTML = `${products.length}`;

          // Changes when colleges added.
          const TotalCollegesElement = document.getElementById("TotalColleges");
          TotalCollegesElement.innerHTML = `${products.length}`;

          grid.replaceChildren();

          products.forEach((product) => {
            // Create a product card element
            let card = document.createElement("div");
            card.classList.add("product-card");

            card.innerHTML = `
            <div class="card-image">
            <img src="${product.image_urls}">
            <span class="tag category-tag">${product.category}</span>
            <span class="tag condition-tag ${product.condition.toLowerCase()}">${
              product.condition
            }</span>
            </div>
            <div class="card-content">
            <h4>${product.title}</h4>
            <p class="price">₹ ${product.price}</p>
            <p class="location"><i class="fa-solid fa-location-dot"></i> ${
              product.location
            }</p>
            <p class="short-desc">${product.description}</p>
            </div>
            `;

            card.addEventListener("click", () => {
              openModal(product);
            });

            // Add the card to the grid
            grid.appendChild(card);
          });
        } catch (error) {
          console.log(
            `Error during loading when filtering by categories ${error.message}`
          );
        }
      }
     

      // Loops for adding eventListener to every category.
      const arrCategory = [
        "All Categories",
        "Furniture",
        "Electronics",
        "Books",
        "Appliances",
        "Clothing",
        "Other",
      ];
      let selectCollege = document.getElementById("filter-btn-college");
      arrCategory.forEach((category) => {
        let filter_btn = document.getElementById(`filter-btn-${category}`);
        filter_btn.addEventListener("click", () => {
          loadProducts(
            `category=${category.toLowerCase()}&college=${selectCollege.value}`
          );
        });
      });

      // This function adds the colleges into the select options when if new college
      //  is added by the user.
      const getAllColleges = async () => {
        let data = await fetch("http://localhost:2000/getAllColleges");
        let colleges = await data.json();
        let selectCollege = document.getElementById("filter-btn-college");

        colleges.forEach((college) => {
          let newOption = document.createElement("option");

          let activeCategory =
            document.getElementsByClassName(".filter-btn active");
          newOption.value = college.name;
          newOption.id = college.name;
          newOption.className = "select-options-college";
          newOption.text = college.name;
          selectCollege.appendChild(newOption);
        });

        selectCollege.addEventListener("change", (e) => {
          let selected = e.target.value;
          loadProducts(
            `category=${
              document.querySelector(".filter-btn.active").value
            }&college=${selected}`
          );
        });
      };


     // Search Bar filter
     let searchBar = document.getElementById('search-bar')
     searchBar.addEventListener('input',()=>{
      let query = searchBar.value.toLowerCase().split(" ").join("")
      let products = document.querySelectorAll('.product-card')
      products.forEach((product)=>{
        let text = product.innerHTML.toLowerCase()
        if(text.includes(query)){
          product.style.display = "block";
        }
        else{
          product.style.display = "none";
        }
      })

     })
     
      // Init
      loadProducts("category=all categories&college=All Colleges");
      getAllColleges();


        (async function() {
            try {
                const loginCheck = await fetch("http://localhost:2000/loginVerify");
                const result = await loginCheck.json();

                let status = document.getElementById("isActive");
                let active = document.getElementById("active");
                const profileDropdown = document.getElementById("profileDropdown");

                if (result == undefined || result.result === "User not verified!") {

                  status.innerText = "Login";
                  active.href = "/pages/login.html";
                
                  profileDropdown.style.display = "none";
                } 
                else {
                    console.log("Index.html----", result);
                    status.innerText = result.username;
                    active.href = "javascript:void(0)"; // disable link
                    
                    active.addEventListener("click", (event) => {
                      event.preventDefault();
                      event.stopPropagation();
                      profileDropdown.classList.toggle("show");
                    });
                  
                    window.addEventListener("click", (event) => {
                      if (
                        profileDropdown.classList.contains("show") &&
                        !active.contains(event.target)
                      ) {
                        profileDropdown.classList.remove("show");
                      }
                    });
                }
        }  catch (err) {
            console.error("Error in login verify fetch:", err);
        }
        })();

        let btn = document.getElementById("logout-btn");
        btn.addEventListener("click", async () => {
            console.log("Im working!")
            await fetch("http://localhost:2000/logout"); 
            window.location.href = "/";
        })
    </script>
    

</body>
</html>
